
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Exploring software technologies">
    <title>Simple Networking - Coldflake Blog</title>
    <link rel="canonical" href="http://blog.coldflake.com/posts/Simple-Networking">
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/coldflake.css">
    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">
    <!-- Custom Fonts -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Bitter:400,700,400italic|Ubuntu:400,500,700" rel="stylesheet" type="text/css">
    <!-- iconfonts -->
    <style type="text/css" media="screen, print">
        @font-face {
          font-family: 'icomoon';
          src:url('/fonts/icomoon.eot');
          src:url('/fonts/icomoon.eot?#iefix') format('embedded-opentype'),
            url('/fonts/icomoon.woff') format('woff'),
            url('/fonts/icomoon.ttf') format('truetype'),
            url('/fonts/icomoon.svg#icomoon') format('svg');
          font-weight: normal;
          font-style: normal;
        }
    </style>
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-21532991-3', 'auto');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
</head>
<body>
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <!-- <a class="navbar&#45;brand" href="/">Coldflake Blog</a> -->
            <a class="navbar-brand" rel="home" href="/" title="home">
              <img style="max-width:120px; margin-top: -7px;" src="/img/mountainBackgroundWhite.png">
            </a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                  <li><a href="/about">About</a></li>
                  <li><a href="/tag">Tags</a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/floorlight.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Simple Networking</h1>
                    <h2 class="subheading">Communicating over UDP sockets in haskell.</h2>
                    <span class="meta">Posted on August 25, 2013
                      <i class="icon-tags"></i> 
                      <a href="/tag/udp">udp</a>, 
                      <a href="/tag/networking">networking</a>, 
                      <a href="/tag/haskell">haskell</a>, 
                      <a href="/tag/C++">C++</a>
                      .
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>
<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div id="tagpie">
            </div>
				<p>Last Friday a <a href="http://sebastianbenz.de/">coworker</a> was so kind to organize a fun session at work where we had to write bots
that participated in a <a href="http://en.wikipedia.org/wiki/Mia_%28game%29">game</a>. The basic idea is to
program a bot that plays against other bots, all communicating via UDP with a server that supervises
the game.<br />
Even though many of our developers are rather avid C++ users, this problem involved two reoccurring
tasks: UDP communication and string handling, both topics that some would claim are not the
particular strong points of C++ (up to the point that it is getting <a href="http://stackoverflow.com/questions/236129/splitting-a-string-in-c">ridiculous</a>)<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>. So most of us
settled on <a href="http://ruby-doc.org/core-2.0/String.html">Ruby</a> or <a href="http://docs.python.org/2/library/string.html">Python</a>, both of which shine especially with string processing.<br />
Haskell supposedly also makes it easy to work with datagram sockets but it always takes me some time
to get it right so this time I wanted to take the time to write down a small UDP sample for future
reference. (there is an abundance of TCP examples out there, but less so for UDP)</p>
<p>Here is a pretty minimal UDP client application in haskell that just connects a datagram socket and
sends some data.<br />
I retrieve the address-information for the server I want to talk to (<code>getAddrInfo</code>), get a socket
(<code>socket</code>) and associate it with the server ip and port (<code>connect</code>). Now I have a socket that can be
used to send datagram packets.<br />
For completeness I wrap the code with <code>bracket</code> just to be sure clean up is done properly in every
case. Donâ€™t mind the <code>withSocketsDo</code>, this is only necessary on windows for some initialization
stuff but usually is included to make the code platform agnostic.</p>
<div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="kr">module</span> <span class="nn">Main</span> <span class="kr">where</span>
<span class="kr">import</span> <span class="nn">Network.Socket</span>
<span class="kr">import</span> <span class="nn">Control.Exception</span>
<span class="nf">port</span> <span class="ow">=</span> <span class="s">&quot;3000&quot;</span>
<span class="nf">main</span> <span class="ow">=</span> <span class="n">withSocketsDo</span> <span class="o">$</span> <span class="n">bracket</span> <span class="n">getSocket</span> <span class="n">sClose</span> <span class="n">talk</span>
        <span class="kr">where</span> <span class="n">getSocket</span> <span class="ow">=</span> <span class="kr">do</span>
                <span class="p">(</span><span class="n">serveraddr</span><span class="kt">:</span><span class="kr">_</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">getAddrInfo</span> <span class="kt">Nothing</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="n">port</span><span class="p">)</span>
                <span class="n">s</span> <span class="ow">&lt;-</span> <span class="n">socket</span> <span class="p">(</span><span class="n">addrFamily</span> <span class="n">serveraddr</span><span class="p">)</span> <span class="kt">Datagram</span> <span class="n">defaultProtocol</span>
                <span class="n">connect</span> <span class="n">s</span> <span class="p">(</span><span class="n">addrAddress</span> <span class="n">serveraddr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">return</span> <span class="n">s</span>
              <span class="n">talk</span> <span class="n">s</span> <span class="ow">=</span> <span class="kr">do</span>
                <span class="n">send</span> <span class="n">s</span> <span class="s">&quot;Hello, world!&quot;</span>
                <span class="n">recv</span> <span class="n">s</span> <span class="mi">1024</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span><span class="n">msg</span> <span class="ow">-&gt;</span> <span class="n">putStrLn</span> <span class="o">$</span> <span class="s">&quot;Received &quot;</span> <span class="o">++</span> <span class="n">msg</span></code></pre></div>
<p>Even though in our scenario writing a server was not required, it proved valuable for test purposes
and I include it for reference.<br />
Here, we build a socket with the address-info and bind it to our own ip on our port (<code>getaddrinfo</code>,
<code>socket</code>, <code>bindSocket</code>). Having bound the socket, we can receive from it and send s.th. back to the
client that sent us a message.</p>
<div class="highlight"><pre><code class="language-haskell" data-lang="haskell"><span class="kr">module</span> <span class="nn">Main</span> <span class="kr">where</span>
<span class="kr">import</span> <span class="nn">Control.Monad</span> <span class="p">(</span><span class="nf">unless</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Network.Socket</span>
<span class="kr">import</span> <span class="nn">Control.Exception</span>
<span class="nf">port</span> <span class="ow">=</span> <span class="s">&quot;3000&quot;</span>
<span class="nf">main</span> <span class="ow">=</span> <span class="n">withSocketsDo</span> <span class="o">$</span> <span class="n">bracket</span> <span class="n">connectMe</span> <span class="n">sClose</span> <span class="n">handler</span>
          <span class="kr">where</span>
            <span class="n">connectMe</span> <span class="ow">=</span> <span class="kr">do</span>
              <span class="p">(</span><span class="n">serveraddr</span><span class="kt">:</span><span class="kr">_</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">getAddrInfo</span>
                                  <span class="p">(</span><span class="kt">Just</span> <span class="p">(</span><span class="n">defaultHints</span> <span class="p">{</span><span class="n">addrFlags</span> <span class="ow">=</span> <span class="p">[</span><span class="kt">AI_PASSIVE</span><span class="p">]}))</span>
                                  <span class="kt">Nothing</span> <span class="p">(</span><span class="kt">Just</span> <span class="n">port</span><span class="p">)</span>
              <span class="n">sock</span> <span class="ow">&lt;-</span> <span class="n">socket</span> <span class="p">(</span><span class="n">addrFamily</span> <span class="n">serveraddr</span><span class="p">)</span> <span class="kt">Datagram</span> <span class="n">defaultProtocol</span>
              <span class="n">bindSocket</span> <span class="n">sock</span> <span class="p">(</span><span class="n">addrAddress</span> <span class="n">serveraddr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">return</span> <span class="n">sock</span>
<span class="nf">handler</span> <span class="ow">::</span> <span class="kt">Socket</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
<span class="nf">handler</span> <span class="n">conn</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">recvFrom</span> <span class="n">conn</span> <span class="mi">1024</span>
    <span class="n">putStrLn</span> <span class="o">$</span> <span class="s">&quot;&lt; &quot;</span> <span class="o">++</span> <span class="n">msg</span>
    <span class="n">unless</span> <span class="p">(</span><span class="n">null</span> <span class="n">msg</span><span class="p">)</span> <span class="o">$</span> <span class="n">sendTo</span> <span class="n">conn</span> <span class="n">msg</span> <span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="n">handler</span> <span class="n">conn</span></code></pre></div>
<pre class="terminal">
$ runghc client
Received Hello, world!
</pre>
<p>For our bot contest I paired with a ruby guy and a simple UPD client is very easy, even though it
does not include any options to setup the address-info or handle graceful shutdown in case of
exceptions:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;socket&#39;</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">3000</span>
<span class="n">sock</span> <span class="o">=</span> <span class="no">UDPSocket</span><span class="o">.</span><span class="n">new</span>
<span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;Hello Server&#39;</span>
<span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
<span class="n">resp</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="nb">p</span> <span class="n">resp</span>
<span class="n">sock</span><span class="o">.</span><span class="n">close</span></code></pre></div>
<pre class="terminal">
$ ruby client.rb
"Hello Server"
</pre>
<p>Pretty interesting to see that even developers with a strong C/C++ background had problems getting
started. But then again itâ€™s definitely more work to get a working client using the posix api. For
the fun, here is the code:</p>
<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;sys/socket.h&gt;</span>
<span class="cp">#include &lt;netdb.h&gt;</span>
<span class="cp">#include &lt;iostream&gt;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="cp">#define SERVERPORT &quot;3000&quot;</span>
<span class="cp">#define SERVERIP &quot;127.0.0.1&quot;</span>
<span class="k">enum</span> <span class="p">{</span> <span class="n">MAX_BUFFER_SIZE</span> <span class="o">=</span> <span class="mi">1024</span> <span class="p">};</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">addrinfo</span> <span class="n">hints</span><span class="p">,</span> <span class="o">*</span><span class="n">servinfo</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Hello World&quot;</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">hints</span><span class="p">);</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">SOCK_DGRAM</span><span class="p">;</span>
    <span class="n">getaddrinfo</span><span class="p">(</span><span class="n">SERVERIP</span><span class="p">,</span> <span class="n">SERVERPORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">servinfo</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">sockfd</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">servinfo</span><span class="p">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ai_next</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sockfd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;client: could not bind socket&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">sent</span> <span class="o">=</span> <span class="n">sendto</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">);</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;sent &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sent</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; bytes to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">SERVERIP</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">MAX_BUFFER_SIZE</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">bytesReceived</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span> <span class="n">sockfd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">MAX_BUFFER_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
    <span class="n">buffer</span><span class="p">[</span><span class="n">bytesReceived</span><span class="p">]</span><span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;received back &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">bytesReceived</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; bytes: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">buffer</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">freeaddrinfo</span><span class="p">(</span><span class="n">servinfo</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>
<pre class="terminal">
$ clang++ -Wall client.cpp -o c
$ ./c
sent 11 bytes to 127.0.0.1
received back 11 bytes: Hello World
</pre>
<p>Besides all the technical details, it is a great way to spend a Friday afternoon and more companies
should consider allowing for such fun events!</p>
<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>Yes, I know about <a href="http://www.boost.org/doc/libs/1_54_0/doc/html/boost_asio.html">asio</a> and <a href="http://www.boost.org/doc/libs/1_54_0/doc/html/string_algo.html">boost string algorithms</a> <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>
                <hr>
                <ul class="pager">
                    <li class="previous">
                    <a href="/posts/happy-new-year-with-shunting-yard" data-toggle="tooltip" data-placement="top" title="Start of Year with Shunting Yard"><i class="fa fa-arrow-left"></i> Older</a>
                    </li>
                    <li class="next">
                    <a href="/posts/The-Incredible-Brew" data-toggle="tooltip" data-placement="top" title="The Incredible Brew">Newer <i class="fa fa-arrow-right"></i></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</article>
<hr>
<script src="/js/d3.min.js"></script>
<script src="/js/tagpie.js"></script>
<script>
  render("tag_ratio.json","#tagpie", 600, 200);
</script>
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                      <a href="/about" title="About">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-user fa-stack-1x fa-inverse"></i>
                            </span>
                      </a>
                    </li>
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="https://twitter.com/marcontwit">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/marcmo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github-alt fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    <li>
                      <a href="mailto:&#111;&#108;&#105;&#118;&#101;&#114;&#046;&#109;&#117;&#101;&#108;&#108;&#101;&#114;&#064;&#103;&#109;&#097;&#105;&#108;&#046;&#099;&#111;&#109;" title="drop me a line">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                      </a>
                    </li>
                </ul>
                <p class="copyright text-muted">Copyright &copy; Coldflake Blog 2014
            </div>
        </div>
    </div>
</footer>
<!-- jQuery -->
<script src="/js/jquery.min.js "></script>
<script src="/js/moment.min.js "></script>
<script src="/js/livestamp.min.js "></script>
<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>
</body>
</html>

