<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Exploring software technologies">

    <title>Testing is fun again - Coldflake Blog</title>

    <link rel="canonical" href="http://blog.coldflake.com/posts/gtest">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/coldflake.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Bitter:400,700,400italic|Ubuntu:400,500,700" rel="stylesheet" type="text/css">

    <!-- iconfonts -->
    <style type="text/css" media="screen, print">
        @font-face {
          font-family: 'icomoon';
          src:url('/fonts/icomoon.eot');
          src:url('/fonts/icomoon.eot?#iefix') format('embedded-opentype'),
            url('/fonts/icomoon.woff') format('woff'),
            url('/fonts/icomoon.ttf') format('truetype'),
            url('/fonts/icomoon.svg#icomoon') format('svg');
          font-weight: normal;
          font-style: normal;
        }
    </style>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-21532991-3', 'auto');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <!-- <a class="navbar&#45;brand" href="/">Coldflake Blog</a> -->
            <a class="navbar-brand" rel="home" href="/" title="home">
              <img style="max-width:120px; margin-top: -7px;" src="/img/mountainBackgroundWhite.png">
            </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                    
                      
                  <li><a href="/about.html">About</a></li>
                      
                    
                
                    
                
                    
                
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                      
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                      
                  <li><a href="/tag/index.html">Tags</a></li>
                      
                    
                
                    
                
                    
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/sun.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Testing is fun again</h1>
                    
                    <h2 class="subheading">Using gtest is by far nicer than cppunit. This is a brief overview of it's usage and some of it's features.</h2>
                    
                    <span class="meta">Posted on July 11, 2011
                      <i class="icon-tags"></i> 
                      
                      <a href="/tag/C++">C++</a>, 
                      
                      <a href="/tag/gtest">gtest</a>, 
                      
                      <a href="/tag/testing">testing</a>
                      .
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<p>A long time now I’ve been faithfully clinging on to <a href="http://apps.sourceforge.net/mediawiki/cppunit/">cppunit</a>, a C++ version of the famous X-Unit-style test frameworks. It has served me well and working around the little glitches did not hurt too much. But it’s a dead project and does not seem to receive love from the developers. Thus I am not really sad to let it go.</p>

<p>But why let it go at all? No more unit-testing? Well… I got kicked in my butt by a colleague that recently started using <a href="http://code.google.com/p/googletest/">google test</a>. So I gave it a try and it has been a pleasure to work with so far! For one it is a very active project and in active use at google (where they do <em>a lot</em> of C++). That alone makes it a much safer bet then cppunit.<br />
Much more important though is the fact that it is simply better. A lot of things are made easier or even possible.<br />
Take for example the distinction between fatal and non fatal error that google test offers: this makes it possible to collect non-fatal errors without exiting the test case (using <code>EXPECT</code>) or state clearly that it makes no sense to continue the test case with a fatal error (using <code>ASSERT</code>).  </p>

<p>Adding messages to failed test case is a breeze… no more messing around with strings, ostreams etc., simply stream the message into the macro:</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">transaction</span><span class="p">.</span><span class="n">getNumberOfUsedJobs</span><span class="p">())</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;no jobs added&quot;</span><span class="p">;</span></code></pre></div>

<p>Using custom messages will make the resulting error message in case of a test failure much more readable:</p>

<pre class="terminal">
[  FAILED  ] TransactionTest.addJob (0 ms)
test/src/TransactionTest.cpp:90: Failure
Value of: transaction.getNumberOfUsedJobs()
  Actual: 1
Expected: 0
no jobs added
</pre>

<p>Two very useful kinds of test are <em>Death Tests</em> and <em>static assertions</em>.  </p>

<h2 id="death-tests">Death Tests</h2>

<p>Death tests let you check for an expected failure like an assert or a bad exit code. They are implemented using a forked sub-process that will be monitored eventually.<br />
The following example shows how to make sure that an assert will happen. Note the regular expression string that can be added to check for the kind of error that has occurred.</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &quot;gtest/gtest.h&quot;</span>

<span class="k">namespace</span> <span class="p">{</span>

<span class="kt">int</span> <span class="n">foo</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">DeathTest</span><span class="p">,</span> <span class="n">foo</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">ASSERT_DEATH</span><span class="p">(</span> <span class="n">foo</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="p">,</span> <span class="s">&quot;.*Assertion.*&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">}</span>  <span class="c1">// namespace</span></code></pre></div>

<h2 id="static-assertions">Static Assertions</h2>

<p>Static asserts come in handy e.g. when you have some compile time configuration or a template meta program that you want to check. (of course boost type traits offer much more here)</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &quot;gtest/gtest.h&quot;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">H</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">typelist</span>
<span class="p">{</span>
    <span class="k">typedef</span> <span class="n">H</span> <span class="n">head</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">T</span> <span class="n">tail</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">null_typelist</span> <span class="p">{};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">TList</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="n">Length</span><span class="p">;</span>
<span class="k">template</span> <span class="o">&lt;&gt;</span> <span class="k">struct</span> <span class="n">Length</span><span class="o">&lt;</span><span class="n">null_typelist</span><span class="o">&gt;</span>
<span class="p">{</span>
    <span class="k">enum</span> <span class="p">{</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">};</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span> <span class="k">class</span> <span class="nc">U</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">Length</span><span class="o">&lt;</span> <span class="n">typelist</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U</span><span class="o">&gt;</span> <span class="o">&gt;</span>
<span class="p">{</span>
    <span class="k">enum</span> <span class="p">{</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">Length</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;::</span><span class="n">value</span> <span class="p">};</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="n">typelist</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span>
        <span class="n">typelist</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span>
        <span class="n">null_typelist</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">testList</span><span class="p">;</span>

<span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span> <span class="n">N</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">IntWrapper</span> <span class="p">{};</span>

<span class="kt">void</span> <span class="nf">testLength</span><span class="p">()</span>
<span class="p">{</span>
    <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">StaticAssertTypeEq</span><span class="o">&lt;</span>
        <span class="n">IntWrapper</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">IntWrapper</span><span class="o">&lt;</span><span class="n">Length</span><span class="o">&lt;</span><span class="n">testList</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
<span class="p">}</span></code></pre></div>

<h2 id="and-there-is-more">and there is more…</h2>

<p>There is an abundance of features to explore (find out more <a href="http://code.google.com/p/googletest/wiki/AdvancedGuide#Selecting_Tests">here</a>). Some of my favorites include</p>

<ul>
  <li>running tests selectively (using pattern matches on the command line)</li>
  <li>shuffling the order in which you tests are run (great! Ever wondered if you might have initialization problems? They might show up only if you execute your test cases in a particular order. That happened to me and I was quite astonished to find out about this when I ran shuffled tests…)</li>
  <li>Type-parameterized tests (let’s you run your templatized code for multiple template instantiations)</li>
  <li>Predicate Formatters (let’s you tune the generated error messages to make them more meaningful)</li>
</ul>

<p>As I said, the project is vibrant and it is to be expected that the current features will be kept in good quality while new features will be added.</p>

<h2 id="from-cppunit-to-gtest">From Cppunit to gtest</h2>

<p>All good news…only that all my tests so far use Cppunit! Thankfully that turned out not to be a major hurdle. Porting tests from Cppunit to google tests is straight forward.<br />
Here an example of a Cppunit-Test:</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="p">...</span>
<span class="k">class</span> <span class="nc">ClosureTest</span> <span class="o">:</span> <span class="k">public</span> <span class="n">CppUnit</span><span class="o">::</span><span class="n">TestFixture</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">ClosureTestCallee</span><span class="o">*</span> <span class="n">fpTestCallee</span><span class="p">;</span>
    <span class="kt">void</span> <span class="nf">setUp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">fpTestCallee</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClosureTestCallee</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="nf">tearDown</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">delete</span> <span class="n">fpTestCallee</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="nf">testClosureWithSingleParameter</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="p">...</span>
        <span class="n">CPPUNIT_ASSERT_EQUAL</span><span class="p">(</span><span class="n">fExpectedCalls</span><span class="p">,</span> <span class="n">fCallbackCalled</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">...</span>

    <span class="n">CPPUNIT_TEST_SUITE</span><span class="p">(</span> <span class="n">ClosureTest</span> <span class="p">);</span>
        <span class="n">CPPUNIT_TEST</span><span class="p">(</span> <span class="n">testClosureWithSingleParameter</span> <span class="p">);</span>
        <span class="p">...</span>
    <span class="n">CPPUNIT_TEST_SUITE_END</span><span class="p">();</span>
<span class="p">};</span>
<span class="n">CPPUNIT_TEST_SUITE_REGISTRATION</span><span class="p">(</span><span class="n">ClosureTest</span><span class="p">);</span></code></pre></div>

<p>To get roughly the same tests using google test, only a little structure and some macros have to be changed. A bonus: the arduous work required by Cppunit to declare testsuites and associated tests is no longer necessary.<br />
Every test case is formulated as a macro which turns out to be a function. The two most common test-defining macros are <code>TEST()</code> and <code>TEST_F()</code>. To mimic the structure of the Cppunit test (which rely on a test fixture using the <code>setUp()</code> and <code>tearDown()</code> functions) you can use the <code>TEST_F()</code> macro which will add a fixture.<br />
Of course you will be guaranteed to get a fresh setup for each test so that your tests do not interfere with each other.</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="p">...</span>
<span class="k">class</span> <span class="nc">ClosureTest</span> <span class="o">:</span> <span class="k">public</span> <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">Test</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">ClosureTestCallee</span><span class="o">*</span> <span class="n">fpTestCallee</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">SetUp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">fpTestCallee</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClosureTestCallee</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">TearDown</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">delete</span> <span class="n">fpTestCallee</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="n">TEST_F</span><span class="p">(</span><span class="n">ClosureTest</span><span class="p">,</span> <span class="n">closureWithSingleParameter</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">fExpectedCalls</span><span class="p">,</span> <span class="n">fCallbackCalled</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">...</span></code></pre></div>

<p>And the test output on the command line is quite readable! One glimpse of the output is enough to capture the most important information about the test outcome:</p>

<pre class="terminal">
...
[----------] 6 tests from SPriorityQueueTest
[ RUN      ] SPriorityQueueTest.constructor
[       OK ] SPriorityQueueTest.constructor (0 ms)
[ RUN      ] SPriorityQueueTest.size
[       OK ] SPriorityQueueTest.size (0 ms)
[ RUN      ] SPriorityQueueTest.empty
[       OK ] SPriorityQueueTest.empty (0 ms)
[ RUN      ] SPriorityQueueTest.full
[       OK ] SPriorityQueueTest.full (0 ms)
[ RUN      ] SPriorityQueueTest.push
[       OK ] SPriorityQueueTest.push (0 ms)
[ RUN      ] SPriorityQueueTest.pop
[       OK ] SPriorityQueueTest.pop (0 ms)
[----------] 6 tests from SPriorityQueueTest (1 ms total)

[----------] Global test environment tear-down
[==========] 131 tests from 16 test cases ran. (14 ms total)
[  PASSED  ] 131 tests.

</pre>

<p>In case of a test failure it is also easy to find out about what went wrong. Let’s break the implementation so that some tests fail:</p>

<pre class="terminal">
[  FAILED  ] SPriorityQueueTest.push (0 ms)
[ RUN      ] SPriorityQueueTest.pop
test/src/util/SPriorityQueue.cpp:78: Failure
Value of: queue.top()
  Actual: 0
Expected: top[i]
Which is: 3
test/src/util/SPriorityQueue.cpp:78: Failure
Value of: queue.top()
  Actual: 0
Expected: top[i]
Which is: 5
[  FAILED  ] SPriorityQueueTest.pop (0 ms)
[----------] 6 tests from SPriorityQueueTest (2 ms total)

[----------] Global test environment tear-down
[==========] 131 tests from 16 test cases ran. (16 ms total)
[  PASSED  ] 129 tests.
[  FAILED  ] 2 tests, listed below:
[  FAILED  ] SPriorityQueueTest.push
[  FAILED  ] SPriorityQueueTest.pop

 2 FAILED TESTS
</pre>

<p>Finally there is more fun in writing unit tests for C++ again! Exploring new ways of how to test your code combined with the much easier management of test cases might contribute to getting your unit tests the attention they deserve :)</p>



                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                    <a href="/posts/cxxproject" data-toggle="tooltip" data-placement="top" title="Building C/C++ Projects with Cxxproject"><i class="fa fa-arrow-left"></i> Older</a>
                    </li>
                    
                    
                    <li class="next">
                    <a href="/posts/the-wonders-of-xargs" data-toggle="tooltip" data-placement="top" title="The Wonders of xargs">Newer <i class="fa fa-arrow-right"></i></a>
                    </li>
                    
                </ul>
            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                      <a href="/about" title="About">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-user fa-stack-1x fa-inverse"></i>
                            </span>
                      </a>
                    </li>
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/marcontwit">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/marcmo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github-alt fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                      <a href="mailto:&#111;&#108;&#105;&#118;&#101;&#114;&#046;&#109;&#117;&#101;&#108;&#108;&#101;&#114;&#064;&#103;&#109;&#097;&#105;&#108;&#046;&#099;&#111;&#109;" title="drop me a line">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                      </a>
                    </li>
                </ul>
                <p class="copyright text-muted">Copyright &copy; Coldflake Blog 2014</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<script src="/js/moment.min.js "></script>
<script src="/js/livestamp.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>



</body>

</html>
